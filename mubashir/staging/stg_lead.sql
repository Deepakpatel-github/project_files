{% set source_name = get_db_name() %}

WITH source AS (
    SELECT * FROM {{source(source_name, 'LEAD')}}
),

intermediate AS (
SELECT
    ID,
    ISDELETED,
    MASTERRECORDID,
    LASTNAME,
    FIRSTNAME,
    SALUTATION,
    MIDDLENAME,
    NAME,
    RECORDTYPEID,
    TITLE,
    COMPANY,
    STREET,
    CITY,
    STATE,
    POSTALCODE,
    COUNTRY,
    LATITUDE,
    LONGITUDE,
    GEOCODEACCURACY,
    ADDRESS,
    PHONE,
    MOBILEPHONE,
    FAX,
    EMAIL,
    WEBSITE,
    PHOTOURL,
    DESCRIPTION,
    LEADSOURCE,
    STATUS,
    INDUSTRY,
    RATING,
    CURRENCYISOCODE,
    ANNUALREVENUE,
    NUMBEROFEMPLOYEES,
    OWNERID,
    HASOPTEDOUTOFEMAIL,
    ISCONVERTED,
    CONVERTEDDATE,
    CONVERTEDACCOUNTID,
    CONVERTEDCONTACTID,
    CONVERTEDOPPORTUNITYID,
    ISUNREADBYOWNER,
    CREATEDDATE,
    CREATEDBYID,
    LASTMODIFIEDDATE,
    LASTMODIFIEDBYID,
    SYSTEMMODSTAMP,
    LASTACTIVITYDATE,
    DONOTCALL,
    HASOPTEDOUTOFFAX,
    LASTVIEWEDDATE,
    LASTREFERENCEDDATE,
    LASTTRANSFERDATE,
    PARTNERACCOUNTID,
    JIGSAW,
    JIGSAWCONTACTID,
    EMAILBOUNCEDREASON,
    EMAILBOUNCEDDATE,
    INDIVIDUALID,
    PRONOUNS,
    GENDERIDENTITY,
    MAIL_OPT_OUT__C,
    BANK_ADDRESS_CITY__C,
    BANK_ADDRESS_COUNTRY__C,
    ANNUALFXVOLUME__C,
    PRIMARYCOMPETITOR__C,
    BANK_ADDRESS_POSTALCODE__C,
    BANK_ADDRESS_STATE__C,
    ELECTRONICSYSTEM__C,
    BANK_ADDRESS_STREET__C,
    BANK_NAME__C,
    HQ_DUNS__C,
    LINE_OF_WORK__C,
    SIEBELNOTES__C,
    TRADESPERMONTH__C,
    MAX_CREDIT__C,
    SALES_PERSON__C,
    PWE_SCORE__C,
    NA0_LEAD_ID__C,
    SITE_INDICATOR__C,
    TURNOVER_BANDING__C,
    ULTIMATE_HQ_DUNS__C,
    ULTIMATE_HQ_NAME__C,
    AVAILABLE_TO_CALL__C,
    LEAD_GENERATOR_GBP__C,
    PROCESS_INTERNATIONAL_PAYMENTS__C,
    TURNOVER_EXPORTED_PCT__C,
    NEXT_ACTIVITY_DATE__C,
    REASONDEAD__C,
    PCTLEADSOURCE__C,
    ANNUAL_SALES__C,
    GOING_PLACES_BRANCH__C,
    FX_REQUIREMENTS_OVERVIEW__C,
    PCT_LEAD_CREATED_BY__C,
    TRAVELEX_BUREAUX__C,
    MARKETO_LEADID__C,
    WORK_PHONE__C,
    MAGAZINE__C,
    EXHIBITION__C,
    AGENT__C,
    EMBASSY__C,
    EXPECTED_FTD__C,
    COUNTRY_OF_PURCHASE__C,
    DUNS_NUMBER__C,
    CTPS_CHECKED_DATE__C,
    CTPS_REGISTERED__C,
    ERP_SYSTEM__C,
    ACCOUNTING_SYSTEM__C,
    COMPANY_ID__C,
    PCT_MOST_TRADED_CURRENCY__C,
    LOCAL_PERCENTAGE__C,
    INFORMATION_REQUIRED__C,
    IMPORT_PERCENTAGE__C,
    EXPORT_PERCENTAGE__C,
    HQ_LOCATION__C,
    TYPE_OF_PAYMENTS__C,
    COMPETITOR_WIRE_FEE__C,
    KEY_REQUIREMENTS__C,
    NO_OF_BENES__C,
    COUNTRY_OF_BENES__C,
    DEAD_LEAD__C,
    USD_PERCENTAGE__C,
    MAJORS_PERCENTAGE__C,
    MINORS_PERCENTAGE__C,
    DOMESTIC_PAYMENTS__C,
    INTERNATIONAL_PAYROLL__C,
    INTERNATIONAL_PENSION__C,
    REPATRIATE_FUNDS__C,
    PERSONAL_PAYMENTS__C,
    SIC_CODE__C,
    INCOMING_PAYMENTS__C,
    LUNN_POLY__C,
    INCOMING_CURRENCIES__C,
    INCOMING_VOLUME__C,
    PAYMENT_PROFILE_COMMENTS__C,
    ONLINE_PERCENTAGE__C,
    OFFLINE_PERCENTAGE__C,
    SPOT_PERCENTAGE__C,
    FORWARDS_PERCENTAGE__C,
    OPTIONS_PERCENTAGE__C,
    EFT_SWIFT_PERCENTAGE__C,
    DRAFT_PERCENTAGE__C,
    ACH_LOW_VALUE_PERCENTAGE__C,
    COMMON_TERMS_OF_TRADE__C,
    APPROVAL_PROCESS__C,
    HEDGING_POLICY__C,
    WHOLESALE_CLIENT__C,
    WHOLESALE_CLIENT_REASON__C,
    FOREIGN_CURRENCY_ACCOUNTS__C,
    FILE_UPLOADS__C,
    COMPETITOR_ONLINE_PLATFORM__C,
    COMPETITOR_FEES__C,
    COMPETITOR_MARGINS__C,
    COMPETITOR_LIKES__C,
    COMPETITOR_DISLIKES__C,
    OVERSEAS_TRAVEL__C,
    TAKE_CREDIT_CARD_PAYMENTS__C,
    H2O__C,
    SELL_ONLINE_VIA_WEBSITE__C,
    FUTURE_PAYMENTS__C,
    REASON_FOR_TRANSFER__C,
    VALUE__C,
    NUMBER_OF_TRANSACTIONS_A_YEAR__C,
    STANDING_ORDERS__C,
    PRODUCT_TYPE__C,
    PAYEE_MANAGER_CHECKS_P_MTH__C,
    PAYEE_MANAGER_CONTRACT_EXPIRATION__C,
    PAYEE_MANAGER_EXPECTED_REVENUE__C,
    OTHER_OPPORTUNITIES__C,
    SETTLEMENT_METHOD__C,
    PERCENTAGE_COMPLETE__C,
    COMPETITOR_DRAFT_FEE__C,
    FORWARDS__C,
    POTENTIAL_VALUE__C,
    COMPLEXITY__C,
    NEXT_STEPS__C,
    COMPANY_CLASSIFICATION__C,
    MODELLED_SALES_FIGURE__C,
    INDUSTRY_REGION__C,
    ONESOURCE__OSKEYID__C,
    SIC_CODE_DESCRIPTION__C,
    COMCODE__C,
    EXTERNAL_VALIDATION_DATE__C,
    LEGAL_COMPANY_NAME__C,
    TRADE_DEBTORS__C,
    EXPORT_TURNOVER__C,
    FISCAL_YEAR_END__C,
    PARTNER_ID__C,
    MARKETO_LEAD_SCORE__C,
    DFX_AGENT__C,
    DFX_LEAD_ORIGIN__C,
    ONLINE_OFFLINE__C,
    CUSTOMER_BUDGETED_GBP_VALUE__C,
    VALUE_OF_CURRENCY__C,
    DRAFTS_PER_MONTH__C,
    FORWARDS_PICKLIST__C,
    REFERRED_BY__C,
    OPTIONS_PICKLIST__C,
    COMPETITOR_SUMMARY__C,
    ANNUAL_SALES_EUR__C,
    SYSTEMS__C,
    SAGA_SOURCE__C,
    DATE_OF_BIRTH__C,
    CASL_COUNTRY_FORMULA__C,
    NACE_CODE_DESCRIPTION__C, 
    
	OVERLAP_FLAG__C ,
	WUBS_ID__C ,
	OVERLAP_ID__C ,
	WUBS_STATUS__C ,
	MIDDLE_INITIAL__C ,
	TIME_AT_ADDRESS__C ,
	EX_DIRECTORY__C ,
	PREVIOUS_ADDRESS__C ,
	PREVIOUS_POSTCODE__C ,
	DATABASE_ID__C ,
	CLEANEDPHONE__C ,
	WORKING_STATUS__C ,
	DB_CREATED_DATE_WITHOUT_TIME__C ,
	DB_LEAD_AGE__C ,
	REFERRED_BY_STAFF__C ,
	OS_INDUSTRY__C ,
	LEAD_ID_18CHAR__C ,
	MQL_DATE__C ,
	AUTO_LEAD_ID__C ,
	COMPLIANCE_APPROVAL_DATE__C ,
	ISELL__OSKEYID__C ,
	TACTIC_SOURCE__C ,
	ELOQUA_IMPORT_UNSUBSCRIBED__C ,
	CLIENT_SIZE__C ,
	LEAD_SCORE__C ,
	AGNT_EMPLOYER__C ,
	AGNT_EMPLOYERS_ADDRESS__C ,
	AGNT_ID_COUNTRY_OF_ISSUE__C ,
	AGNT_ID_DATE_OF_ISSUANCE__C ,
	AGNT_ID_EXPIRATION_DATE__C ,
	AGNT_ID_NUMBER__C ,
	AGNT_ID_TYPE__C ,
	AGNT_OCCUPATION__C ,
	AGNT_PRINCIPAL_BUSINESS_ACTIVITY__C ,
	AGNT_PURPOSE_OF_PAYMENTS_OTHER_DETAILS__C ,
	AGNT_PURPOSE_OF_PAYMENTS__C ,
	AGNT_REQUESTED_CORRESPONDENCE_METHOD__C ,
	AGNT_RISK_LEVEL__C ,
	AGNT_TAX_ID__C ,
	DNB_MATCH_CONFIDENCE_CODE__C ,
	DATE_OF_INCORPORATION__C ,
	AGNT_TYPE_OF_ENTITY__C ,
	SECONDARY_PROVIDER__C ,
	UIIC__C ,
	UBIGEO__C ,
	MOSTTRADEDCURRENCIES__C ,
	PLACE_OF_BIRTH__C ,
	LANGUAGE_PREFERENCE__C ,
	YEAR_STARTED_BUSINESS__C ,
	LAST_WEB_EMAIL_ACTIVITY__C ,
	NURTURING_PROGRAMS_FLAG__C ,
	ESTIMATED_GROSS_REVENUE__C ,
	LEAD_OWNER_NAME_FORMULA__C ,
	EXPECTED_SOLUTION__C ,
	USD_INTERNATIONALLY_ONLY__C ,
	LEAD_OWNER_EMAIL_FORMULA__C ,
	ONLINE_ENGAGEMENT_SCORE__C ,
	ONLINE_ENGAGEMENT_SCORE_DATE__C ,
	SERVICE_PLAN__C ,
	DATE_TIME_CONSENT_WAS_OBTAINED__C ,
	CONSENT_OBTAINED_ORALLY_OR_IN_WRITING__C ,
	CONSENT_CONTENT__C ,
	MANNER_IN_WHICH_CONSENT_WAS_OBTAINED__C ,
	IMPLIED_CONSENT__C ,
	BEST_DAY_TO_REACH__C ,
	BEST_TIME_TO_REACH__C ,
	APP_RECEIVED_DATE__C ,
	VCE_QUESTIONNAIRE_COMPLETED_DATE__C ,
	APP_COLLECTED_BY__C ,
	VISIBILITY_ASSESSMENT__C ,
	CERTAINTY_ASSESSMENT__C ,
	EFFICIENCY_ASSESSMENT__C ,
	VCE_ASSESSMENT__C ,
	OWNER_IS_A_QUEUE__C ,
	OLDID__C ,
	LEI_NUMBER__C ,
	EMPLOYEE_FIRST_NAME__C ,
	EMPLOYEE_LAST_NAME__C ,
	EMPLOYEE_NUMBER__C ,
	EMPLOYEE_EMAIL__C ,
	EMPLOYEE_PHONE_NUMBER__C ,
	NATURE_OF_EMPL_RELATIONSHIP_TO_CONTACT__C ,
	DURATION_OF_EMPLOYEE_RELATIONSHIP__C ,
	LG_SOURCE__C ,
	OPPORTUNITIES__C ,
	EMPLOYEE_REFERRAL_DATE_TIME__C ,
	CAMPAIGN_NAME__C ,
	REFERRAL_APPROVED__C ,
	EMPLOYEE_COUNTRY__C ,
	DO_NOT_SYNC_WITH_ELOQUA__C ,
	NUMBER_OF_COMPETITORS__C ,
	LEAD_STATUS_LAST_MODIFIED_DATE__C ,
	LEAD_STATUS_LAST_MODIFIED_BY__C ,
	REASON_FOR_FX_TRANSACTIONS__C ,
	BLUEKAI_VISITOR_ID__C ,
	NACE_CODE__C ,
	FOREIGN_CURRENCY_ACCOUNT__C ,
	CONSENT_EXPIRATION_DATE__C ,
	LEAD_SOURCE_TRACKING__C ,
	CONSENT_TYPE__C ,
	DATE_BUSINESS_CARD_OBTAINED__C ,
	DATE_EMAIL_ADDRESS_OBTAINED__C ,
	HOW_IS_WUBS_RELEVANT_TO_THIS_CONTACT__C ,
	IMPLIED_CONSENT_TYPE_CASL__C ,
	TYPE_OF_BUSINESS_RELATIONSHIP__C ,
	DAILY_MARKET_COMMENTARY__C ,
	INDUSTRY_GBP__C ,
	TRADING_CYCLE__C ,
	PAYMENTS_PER_CYCLE__C ,
	AVG_SIZE_PER_PAYMENT__C ,
	EXPECTED_MARGIN__C ,
	FY_WALLET_SIZE_VOLUME__C ,
	EXPECTED_ANNUAL_REVENUE__C ,
	PRIMARY_COMPETITOR_REASON__C ,
	LID__LINKEDIN_COMPANY_ID__C ,
	OPPORTUNITY_DESCRIPTION__C ,
	IMPORTER_EXPORTER__C ,
	LID__LINKEDIN_MEMBER_TOKEN__C ,
	SECONDARY_COMPETITOR__C ,
	GROWTHINTEL_GRADE__C ,
	GROWTHINTEL_LEAD_ID__C ,
	GROWTHINTEL_RECOMMENDATION_SIGNALS__C ,
	LAST_DIGITAL_ENGAGEMENT_DATE__C ,
	TYPE__C ,
	OPTIONS_GBP__C ,
	TREASURY_MANAGEMENT_SYSTEM__C ,
	CURRENCIES__C ,
	ONLINE__C ,
	PRIMARY_COMPETITOR_GBP__C ,
	REGION_GBP__C ,
	LEAD_SOURCE_NAME__C ,
	EMAIL_OPT_IN_DATE__C ,
	HIGHEST_EXPORTED_COMMODITY__C ,
	STATUS_DETAIL_GBP__C ,
	LEAD_SOURCE_GBP__C ,
	HIGHEST_IMPORTED_COMMODITY__C ,
	EXPECTED_WALLET_SHARE__C ,
	EXPECTED_FY_VOLUME_GBP__C ,
	TOTAL_ASSET_AMOUNT__C ,
	TOTAL_LIABILITIES_AMOUNT__C ,
	COMPANY_OVERVIEW__C ,
	EXPECTED_FTD_GBP__C ,
	MULTIPLE_PROVIDER_REASON__C ,
	GM_ID__C ,
	GM_RECID__C ,
	GOLDMINE_DATA__C ,
	GOLDMINE_SOURCE__C ,
	RUESCH_OFFICE__C ,
	REFERRED_BY_ENTITY__C ,
	KEY_TO_PARENT__C ,
	EXPECTED_REVENUE__C ,
	PLATFORMS_TO_BE_OFFERED__C ,
	PRODUCTS_TO_BE_OFFERED__C ,
	CHANNEL_PARTNER_TYPE__C ,
	CHANNEL_PARTNER__C ,
	BUSINESS_IS_ACTIVE_INDICATOR__C ,
	EMAIL_OPT_IN_TYPE__C ,
	LINE_OF_BUSINESS__C ,
	IMPORTER_EXPORTER_DESCRIPTION__C ,
	OUT_OF_BUSINESS_INDICATOR__C ,
	SHOWPADFORSF__SHOWPAD_ACTIVITY_COUNT__C ,
	SHOWPADFORSF__SHOWPAD_LAST_ACTIVITY_DATE__C ,
	SHOWPADFORSF__SHOWPAD_LAST_VIEW_DATE__C ,
	SHOWPADFORSF__SHOWPAD_LAST_VIEWED_CONTENT__C ,
	SHOWPADFORSF__SHOWPAD_VIEW_COUNT__C ,
	ADMIN_UPDATE_FLAG__C ,
	LEGACY_LEAD_SOURCE__C ,
	UTM_CONTENT__C ,
	UTM_MEDIUM__C ,
	UTM_TERM__C ,
	EMPLOYEE_REFERRAL_ACCEPTED_BY_GTM_LEADER__C ,
	EMPLOYEE_REFERRAL_APPROVAL_COMMENTS__C ,
	EMPLOYEE_REFERRAL_APPROVAL_DATE__C ,
	EMPLOYEE_REFERRAL_APPROVAL_STATUS__C ,
	EMPLOYEE_REFERRAL_APPROVED_BY__C ,
	DETAILS_OF_BANK_RELATIONSHIP__C ,
	EXCLUSIVE_CONTRACT_END__C ,
	FINANCIAL_STRENGTH__C ,
	INT_L_TUITION_ADDRESSABLE_VOLUME__C ,
	INT_L_TUITION_FULL_WALLET__C ,
	INT_L_TUITION_POTENTIAL_REVENUE__C ,
	INTERNATIONAL_STUDENTS__C ,
	INTERNATIONAL_TUITION_FEE__C ,
	PAYMENT_DEADLINE_FALL__C ,
	PAYMENT_DEADLINE_WINTER__C ,
	RFP_EXPIRY_DATE__C ,
	RFP_RELEASED_DATE__C ,
	REVENUE_SHARE_TO_BE_OFFERED__C ,
	SCHOOL_INTEGRATION_STATUS__C ,
	SCHOOL_S_PAYMENT_PAGE_LINK__C ,
	TOTAL_STUDENTS__C ,
	UNIVERSITY_ID__C ,
	UNIVERSITY_BANKING_PARTNER__C ,
	EMAIL_OPT_IN_TYPE_LAST_UPDATED__C ,
	GDPR_COUNTRY__C ,
	STATEORPROVINCE__C ,
	TRADING_ADDRESS_COUNTRY__C ,
	LEAD_CREATED_USING_SCREEN_FLOW__C ,
	B10__C ,
	B1__C ,
	B2__C ,
	B3__C ,
	B4__C ,
	B5__C ,
	B6__C ,
	B7__C ,
	B8__C ,
	B9__C ,
	BUSINESS_CRITERIA_SCORE__C ,
	LAST_SCORECARD_UPDATE__C ,
	O10__C ,
	O1__C ,
	O2__C ,
	O3__C ,
	O4__C ,
	O5__C ,
	O6__C ,
	O7__C ,
	O8__C ,
	O9__C ,
	OPPORTUNITY_CRITERIA_SCORE__C ,
	SCORECARD_LAST_UPDATED_BY__C ,
	TOTAL_SCORE_FORMULA__C ,
	ZOOM_APP__ISCREATEDBYZOOMAPP__C ,
	NAICS_CODE_1__C ,
	SUB_SEGMENT__C ,
	LEADER_SEGMENT__C ,
	STRATEGIC_SEGMENT__C ,
	LEAD_FULL_NAME__C ,
	SUB_SEGMENT_CALCULATED__C ,
	DNB_CONNECT_DUNS__C ,
	DNB_EXCLUDE_COMPANY__C ,
	DISQUALIFIED_DATE__C ,
	MAL_DATE__C ,
	NEW_MQL_DATE__C ,
	PROSPECT_DATE__C ,
	SAL_DATE__C ,
	DNBCONNECT__D_B_CONNECT_COMPANY_PROFILE__C ,
	DNBCONNECT__D_B_CONNECT_CONTACT_PROFILE__C ,
	DNBCONNECT__D_B_CONTACT_MATCH_DRIVER__C ,
	DNBCONNECT__D_B_MATCH_CONFIDENCE_CODE__C ,
	DNBCONNECT__D_B_MATCH_DATA_PROFILE__C ,
	DNBCONNECT__D_B_MATCH_GRADE__C ,
	DNBCONNECT__D_B_MATCH_TYPE__C ,
	DNBCONNECT__D_B_NAME_MATCH_SCORE__C ,
	DNBCONNECT__DUNSTRADEDUP__C ,
	DNBCONNECT__MATCHEDDUNS__C ,
	MATCHINGACCOUNT__C ,
	MATCHINGACCOUNTOWNER__C ,
	MATCHINGACCOUNTSTATUS__C ,
	PARTITION_YEAR ,
	PARTITION_MONTH ,
	PARTITION_DAY ,
	LOAD_DATETIME ,
	SFK_RECORD_CREATE_DT ,
	SFK_RECORD_UPDATE_DT ,
	INPUT_FILE_NAME ,
	IS_ACTIVE,
    'sfdc' AS source_system_name,
    'salesforce_lead' AS source_system_primary_table_name,
    ID as source_system_primary_key,
    SFK_RECORD_UPDATE_DT as landing_updated_date_time
 
 from  source
),

final as (
      select * 
    from
        (
            select *, row_number() over(partition by id order by sfk_record_update_dt DESC, load_datetime desc) as rnk
            from intermediate
        ) as t
    where rnk = 1 
)

SELECT * FROM final

